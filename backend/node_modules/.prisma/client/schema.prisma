generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Empresa/Tenant principal
model Company {
  id        String   @id @default(uuid())
  name      String
  logo      String?
  address   String?
  phone     String?
  email     String?
  timezone  String   @default("America/Mexico_City")
  currency  String   @default("MXN")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  locations Location[]
  users     User[]
  positions Position[]

  @@map("companies")
}

// Sucursales/Locaciones
model Location {
  id             String   @id @default(uuid())
  companyId      String
  name           String
  address        String?
  phone          String?
  email          String?
  timezone       String   @default("America/Mexico_City")
  isHeadquarters Boolean  @default(false) // Si es la central
  isActive       Boolean  @default(true)
  clockToken     String?  @unique @default(uuid()) // Token unico para acceso del reloj de asistencia
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  company       Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  shifts        Shift[]
  timesheets    Timesheet[]
  userLocations UserLocation[]

  @@map("locations")
}

// Usuarios/Empleados
model User {
  id         String   @id @default(uuid())
  companyId  String
  email      String   @unique
  password   String
  firstName  String
  lastName   String
  phone      String?
  avatar     String?
  pin        String? // PIN de 4 digitos para marcar asistencia
  role       Role     @default(EMPLOYEE)
  isActive   Boolean  @default(true)
  canViewAll Boolean  @default(false) // Puede ver todas las sucursales
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  company          Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  userLocations    UserLocation[]
  userPositions    UserPosition[]
  shifts           Shift[]
  timesheets       Timesheet[]
  timeOffRequests  TimeOffRequest[]
  approvedRequests TimeOffRequest[] @relation("ApprovedBy")

  @@map("users")
}

enum Role {
  SUPER_ADMIN // Puede ver y gestionar todo
  ADMIN // Admin de la empresa
  MANAGER // Manager de sucursal(es)
  SUPERVISOR // Supervisor
  EMPLOYEE // Empleado regular
}

// Relacion Usuario-Ubicacion (a que sucursales tiene acceso)
model UserLocation {
  id         String   @id @default(uuid())
  userId     String
  locationId String
  isPrimary  Boolean  @default(false) // Sucursal principal del empleado
  createdAt  DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([userId, locationId])
  @@map("user_locations")
}

// Puestos/Cargos
model Position {
  id          String   @id @default(uuid())
  companyId   String
  name        String
  description String?
  color       String   @default("#3B82F6") // Color para el calendario
  hourlyRate  Decimal? @db.Decimal(10, 2)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company       Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  userPositions UserPosition[]
  shifts        Shift[]

  @@map("positions")
}

// Relacion Usuario-Posicion
model UserPosition {
  id         String   @id @default(uuid())
  userId     String
  positionId String
  createdAt  DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  position Position @relation(fields: [positionId], references: [id], onDelete: Cascade)

  @@unique([userId, positionId])
  @@map("user_positions")
}

// Turnos
model Shift {
  id           String      @id @default(uuid())
  locationId   String
  userId       String? // Null si es OpenShift
  positionId   String? // Null si es DayOff
  date         DateTime    @db.Date
  startTime    DateTime?   @db.Time(0) // Null si es DayOff
  endTime      DateTime?   @db.Time(0) // Null si es DayOff
  breakMinutes Int         @default(0)
  notes        String?     @db.Text
  status       ShiftStatus @default(SCHEDULED)
  isOpenShift  Boolean     @default(false) // Turno disponible para tomar
  isPublished  Boolean     @default(false)
  isDayOff     Boolean     @default(false) // Es dia libre
  dayOffType   DayOffType? // Tipo de dia libre
  isPaid       Boolean     @default(true) // Si es pagado o no
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  location  Location   @relation(fields: [locationId], references: [id], onDelete: Cascade)
  user      User?      @relation(fields: [userId], references: [id], onDelete: SetNull)
  position  Position?  @relation(fields: [positionId], references: [id], onDelete: Cascade)
  timesheet Timesheet?

  @@index([locationId, date])
  @@index([userId, date])
  @@map("shifts")
}

enum DayOffType {
  DAY_OFF // Franco/Dia libre regular
  SICK // Enfermedad
  VACATION // Vacaciones
  HOLIDAY // Festivo/Feriado
  PERSONAL // Asunto personal
  MATERNITY // Maternidad
  PATERNITY // Paternidad
  BEREAVEMENT // Duelo
  UNPAID_LEAVE // Licencia sin goce
  OTHER // Otro
}

enum ShiftStatus {
  SCHEDULED // Programado
  CONFIRMED // Confirmado por empleado
  IN_PROGRESS // En curso
  COMPLETED // Completado
  CANCELLED // Cancelado
  NO_SHOW // No se presento
}

// Registro de tiempo (Asistencia)
model Timesheet {
  id           String          @id @default(uuid())
  shiftId      String?         @unique
  locationId   String
  userId       String
  date         DateTime        @db.Date
  clockIn      DateTime?
  clockOut     DateTime?
  breakStart   DateTime?
  breakEnd     DateTime?
  totalMinutes Int?
  status       TimesheetStatus @default(PENDING)
  notes        String?         @db.Text
  approvedBy   String?
  approvedAt   DateTime?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  shift    Shift?   @relation(fields: [shiftId], references: [id], onDelete: SetNull)
  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([locationId, date])
  @@index([userId, date])
  @@map("timesheets")
}

enum TimesheetStatus {
  PENDING // Pendiente
  SUBMITTED // Enviado para aprobar
  APPROVED // Aprobado
  REJECTED // Rechazado
}

// Solicitudes de tiempo libre
model TimeOffRequest {
  id             String        @id @default(uuid())
  userId         String
  type           TimeOffType
  startDate      DateTime      @db.Date
  endDate        DateTime      @db.Date
  reason         String?       @db.Text
  status         TimeOffStatus @default(PENDING)
  approvedById   String?
  approvedAt     DateTime?
  rejectedReason String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  user       User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  approvedBy User? @relation("ApprovedBy", fields: [approvedById], references: [id], onDelete: SetNull)

  @@index([userId, status])
  @@map("time_off_requests")
}

enum TimeOffType {
  VACATION // Vacaciones
  SICK // Enfermedad
  PERSONAL // Personal
  MATERNITY // Maternidad
  PATERNITY // Paternidad
  BEREAVEMENT // Duelo
  OTHER // Otro
}

enum TimeOffStatus {
  PENDING // Pendiente
  APPROVED // Aprobado
  REJECTED // Rechazado
  CANCELLED // Cancelado
}
